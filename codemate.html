<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Practice Environment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/clike/clike.min.js"></script>
    <style>
        body {
            background-color: #212529; 
        }
        .CodeMirror {
            border-radius: 0.5rem;
            height: 450px;
            font-size: 16px;
        }
        .modal-backdrop {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1050;
        }
        #feedback-container, #results-output, #console-output {
            white-space: pre-wrap;
            font-family: monospace;
        }
        .test-case {
            background-color: #495057;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-family: monospace;
        }
        .lang-btn.active {
            background-color: #198754; 
            border-color: #198754;
        }
        
        #success-feedback-container {
            display: none;
        }
    </style>
</head>
<body class="text-light">
    <div id="difficulty-modal" class="modal-backdrop">
        <div class="bg-dark shadow-lg rounded-3 p-5 text-center">
            <h2 class="mb-4">Select Difficulty Level</h2>
            <div class="d-flex justify-content-center gap-3">
                <button onclick="selectDifficulty('Easy')" class="btn btn-success btn-lg px-4">Easy</button>
                <button onclick="selectDifficulty('Medium')" class="btn btn-warning btn-lg px-4">Medium</button>
                <button onclick="selectDifficulty('Hard')" class="btn btn-danger btn-lg px-4">Hard</button>
            </div>
        </div>
    </div>

    <div id="main-content" class="container py-4 d-none">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="bg-dark p-4 rounded-3 shadow-sm d-flex flex-column h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1>DSA Challenge</h1>
                        <div id="timer" class="fs-2 font-monospace bg-secondary text-white px-3 py-1 rounded">10:00</div>
                    </div>
                    <div id="question-container" class="mb-4 flex-grow-1">
                        <h2 id="question-title" class="mb-2"></h2>
                        <p id="question-description" class="text-body-secondary mb-4"></p>
                        <h5 class="mb-2">Example:</h5>
                        <div id="example-container"></div>
                    </div>
                    <div class="d-flex gap-3 mb-4">
                        <button id="run-code-btn" class="btn btn-info w-50">Run Code</button>
                        <button id="get-clue-btn" class="btn btn-primary w-50">Get Clue</button>
                    </div>
                     <div class="bg-secondary p-3 rounded" style="min-height: 100px;">
                        <h5 class="mb-2">Hint / Suggestion</h5>
                        <div id="feedback-container" class="fst-italic">Click "Get Clue" or wait for periodic feedback...</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="d-flex gap-2 mb-2">
                    <button id="lang-python" class="lang-btn btn btn-secondary btn-sm">Python</button>
                    <button id="lang-java" class="lang-btn btn btn-secondary btn-sm">Java</button>
                    <button id="lang-cpp" class="lang-btn btn btn-secondary btn-sm">C++</button>
                </div>
                <textarea id="code-editor"></textarea>
                
                <div id="success-feedback-container" class="mt-4">
                    <div class="alert alert-info">
                        <h5 class="alert-heading">üí° Code Feedback & Next Steps</h5>
                        <hr>
                        <p id="success-feedback-content" class="mb-0"></p>
                    </div>
                </div>

                <div class="bg-dark p-3 rounded-3 mt-4 shadow-sm">
                     <h5 class="mb-2 text-body-secondary">Console Output</h5>
                     <div id="console-output" class="bg-black p-2 rounded" style="min-height: 75px;">...</div>
                </div>
                <div class="bg-dark p-3 rounded-3 mt-4 shadow-sm">
                     <h5 class="mb-2 text-body-secondary">Test Results</h5>
                     <div id="results-output" class="fst-italic">Click "Run Code" to see your results.</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script src="questions.js"></script>
    
    <script>
        
        const OLLAMA_API_URL = "http://localhost:11434/api/generate";
        const OLLAMA_MODEL = "gemma3:1b" 
         //const OLLAMA_MODEL = "codellama";



        async function getOllamaResponse(prompt) {
            try {
                const start = performance.now();
                const response = await fetch(OLLAMA_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: OLLAMA_MODEL, prompt: prompt, stream: false }),
                });
                if (!response.ok) throw new Error(`Ollama API request failed: ${response.statusText}`);
                const end = performance.now();
                const data = await response.json();
                console.log(`‚è±Ô∏è Network Latency: ${(end - start).toFixed(2)} ms`);
                return data.response.trim();
            } catch (error) {
                console.error("Error communicating with Ollama:", error);
                if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    return `ERROR: A network error occurred due to CORS. Please start your Ollama server with OLLAMA_ORIGINS=* to fix this. Example: OLLAMA_ORIGINS=* ollama serve`;
                }
                return `ERROR: Could not connect to Ollama. Make sure it's running. Details: ${error.message}`;
            }
        }

      
        async function getHintForProblem(problem) {
            const prompt = `Give a short, cryptic hint for this problem in under 25 words. Focus on a data structure or a core concept. Do NOT provide code or a full explanation. Problem: ${problem}`;
            return await getOllamaResponse(prompt);
        }

        
        async function getFeedbackForCode(code, problem) {
            if (!code || code.trim().length < 10) return null;
            const prompt = `Based on this code for "${problem}",understand the approch of the user only dont give hints  with respective optimal approach only give hints bases on the user approach what he should do next,is ther any mistake with respective probloem statementand give a one-sentence hint (max 15 words) to guide the user to the next step. Do not give the solution. Hint at a possible refinement or logical next step.the response should be like -you may try in this approach/may be it can works ,respond in shuch a way you are friendly to the use dont address as user address as you/myfriend dont exceed more than 40 words Code:\n${code}`;
            return await getOllamaResponse(prompt);
        }
        
        
        
        async function getSuccessFeedback(language, code, problemTitle) {
            const prompt = `This is a user's correct ${language} solution for "${problemTitle}". Provide friendly and encouraging feedback in about 30-40 words. Briefly comment on their approach and suggest one potential optimization or an alternative way to think about the problem (e.g., time/space complexity) give time complexity of the code.But dont give any code just explain different approach which are better than the user code Code:\n${code}`;
           

   return await getOllamaResponse(prompt);
        }
function extractMethodName(language, userCode) {
    if (language === "python") {
        const match = userCode.match(/def\s+([a-zA-Z0-9_]+)\s*\(/);
        return match ? match[1] : null;
    }
    if (language === "java") {
        const match = userCode.match(/(?:public\s+)?(?:int|boolean|void|double|char|String|List<.*>|int\[\]|char\[\]|ListNode|TreeNode)\s+([a-zA-Z0-9_]+)\s*\(/);
        return match ? match[1] : null;
    }
    if (language === "cpp") {
        const match = userCode.match(/[a-zA-Z0-9_<>*&]+\s+([a-zA-Z0-9_]+)\s*\(/);
        return match ? match[1] : null;
    }
    return null;
}

function wrapCodeForExecution(language, userCode, testCase) {
    const functionName = extractMethodName(language, userCode);

    if (!functionName) {
        return userCode; 
    }

   
    if (language === "python") {
        return `
${userCode}

if __name__ == "__main__":
    sol = Solution()
    print(sol.${functionName}(*${JSON.stringify(testCase.input)}))
`;
    }

    if (language === "java") {
        let javaArgs = testCase.input.map(arg => {
            if (Array.isArray(arg)) return "new int[]{" + arg.join(",") + "}";
            if (typeof arg === "string") return `"${arg}"`;
            return arg;
        }).join(", ");

        return `
${userCode}

class Main {
    public static void main(String[] args) {
        Solution sol = new Solution();
        Object result = sol.${functionName}(${javaArgs});
        if (result instanceof int[]) {
            System.out.println(java.util.Arrays.toString((int[]) result));
        } else if (result instanceof char[]) {
            System.out.println(java.util.Arrays.toString((char[]) result));
        } else {
            System.out.println(result);
        }
    }
}
`;
    }


    if (language === "cpp") {
        let cppArgs = testCase.input.map(arg => {
            if (Array.isArray(arg)) return "std::vector<int>{" + arg.join(",") + "}";
            if (typeof arg === "string") return `"${arg}"`;
            return arg;
        }).join(", ");

        return `
#include <iostream>
#include <vector>
#include <string>
using namespace std;

${userCode}

template <typename T>
void printVector(const vector<T>& v) {
    cout << "[";
    for (size_t i = 0; i < v.size(); i++) {
        cout << v[i];
        if (i < v.size() - 1) cout << ",";
    }
    cout << "]";
}

int main() {
    Solution sol;
    auto res = sol.${functionName}(${cppArgs});
    if constexpr (is_same<decltype(res), bool>::value) {
        cout << (res ? "true" : "false") << endl;
    } else if constexpr (is_same<decltype(res), vector<int>>::value) {
        printVector(res);
        cout << endl;
    } else if constexpr (is_same<decltype(res), vector<char>>::value) {
        printVector(res);
        cout << endl;
    } else {
        cout << res << endl;
    }
    return 0;
}
`;
    }

    return userCode;
}


        async function getExecutionResult(language, userCode, testCase) {
    const langIds = { python: 71, java: 62, cpp: 54 };
    const language_id = langIds[language];

    
    let inputData = "";
    if (Array.isArray(testCase.input)) {
        inputData = JSON.stringify(testCase.input);
    } else {
        inputData = String(testCase.input);
    }
    const wrappedCode = wrapCodeForExecution(language, userCode, testCase, currentQuestion.title.replace(/\s+/g, ''));
   
    try {
        const response = await fetch("https://judge0-ce.p.rapidapi.com/submissions?base64_encoded=false&wait=true", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-RapidAPI-Host": "judge0-ce.p.rapidapi.com",
                "X-RapidAPI-Key":"Replace with your rapid api key"
            },
            body: JSON.stringify({
                language_id,
                source_code: wrappedCode
            })
        });
       ;
        if (!response.ok) {
            return { actualResult: `ERROR: Judge0 API failed (${response.status})`, consoleOutput: "" };
        }

        const result = await response.json();
        
        return {
            actualResult: result.stdout ? result.stdout.trim() : (result.stderr || result.compile_output || "No output"),
            consoleOutput: result.stdout || result.stderr || ""
        };

    } catch (error) {
        console.error("Judge0 API error:", error);
        return { actualResult: `ERROR: ${error.message}`, consoleOutput: "" };
    }
}

        const difficultyModal = document.getElementById('difficulty-modal');
        const mainContent = document.getElementById('main-content');
        const timerEl = document.getElementById('timer');
        const questionTitleEl = document.getElementById('question-title');
        const questionDescriptionEl = document.getElementById('question-description');
        const exampleContainer = document.getElementById('example-container');
        const getClueBtn = document.getElementById('get-clue-btn');
        const runCodeBtn = document.getElementById('run-code-btn');
        const feedbackContainer = document.getElementById('feedback-container');
        const consoleOutput = document.getElementById('console-output');
        const resultsOutput = document.getElementById('results-output');
        const langButtons = document.querySelectorAll('.lang-btn');
        const successFeedbackContainer = document.getElementById('success-feedback-container');
        const successFeedbackContent = document.getElementById('success-feedback-content');

        let editor;
        let currentQuestion;
        let timerInterval;
        let feedbackInterval;
        let currentLanguage = 'python';

        editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            lineNumbers: true, mode: currentLanguage, theme: 'material-darker', indentUnit: 4,
        });

        function selectDifficulty(level) {
            difficultyModal.classList.add('d-none');
            mainContent.classList.remove('d-none');
            loadQuestion(level);
            let timer=level=="Easy"?600:1000
            startTimer(timer);
            startPeriodicFeedback();
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            const langConfig = { python: 'python', java: 'text/x-java', cpp: 'text/x-c++src' };
            editor.setOption("mode", langConfig[lang]);
            
            langButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.id === `lang-${lang}`) {
                    btn.classList.add('active');
                }
            });

            if (currentQuestion) {
                editor.setValue(currentQuestion.templates[currentLanguage]);
            }
        }

        function loadQuestion(level) {
            successFeedbackContainer.style.display = 'none';
            const levelQuestions = questions[level];
            currentQuestion = levelQuestions[Math.floor(Math.random() * levelQuestions.length)];
            
            questionTitleEl.textContent = currentQuestion.title;
            questionDescriptionEl.textContent = currentQuestion.description;

            const example = currentQuestion.testCases[0];
            exampleContainer.innerHTML = `<div class="test-case"><strong>Input:</strong> ${JSON.stringify(example.input)}<br><strong>Expected:</strong> ${JSON.stringify(example.expected)}</div>`;
            setLanguage(currentLanguage);
        }

        function startTimer(duration) {
            clearInterval(timerInterval);
            let timer = duration;
            timerInterval = setInterval(() => {
                const minutes = String(Math.floor(timer / 60)).padStart(2, '0');
                const seconds = String(timer % 60).padStart(2, '0');
                timerEl.textContent = `${minutes}:${seconds}`;
                if (--timer < 0) {
                    clearInterval(timerInterval);
                    timerEl.textContent = "Time's Up!";
                    getClueBtn.disabled = true;
                    runCodeBtn.disabled = true;
                    clearInterval(feedbackInterval);
                }
            }, 1000);
        }
        
        function startPeriodicFeedback() {
            clearInterval(feedbackInterval);
            feedbackInterval = setInterval(async () => {
                const code = editor.getValue();
                const feedback = await getFeedbackForCode(code, currentQuestion.title);
                if (feedback && !feedback.startsWith("ERROR:")) {
                     feedbackContainer.textContent = `Periodic suggestion: ${feedback}`;
                }
            }, 100000);
        }

        async function runCode() {
            console.log("exucuting started");
            const userCode = editor.getValue();
            const { testCases } = currentQuestion;
            resultsOutput.innerHTML = 'Running tests...';
            consoleOutput.innerHTML = '...';
            successFeedbackContainer.style.display = 'none';
            runCodeBtn.disabled = true;
        
            let allPassed = true;
            for (let i = 0; i < testCases.length; i++) {
                const testCase = testCases[i];
                resultsOutput.innerHTML = `Running Test Case ${i + 1}/${testCases.length}...`;
               
                const result = await getExecutionResult(currentLanguage, userCode, testCase);
             
                if (result.actualResult.startsWith('ERROR:')) {
                    resultsOutput.innerHTML = `<div class="alert alert-danger">${result.actualResult}</div>`;
                    allPassed = false;
                    break;
                }

let parsedActual;
try {
    
    parsedActual = JSON.parse(result.actualResult);
} catch (e) {
    let cleaned = result.actualResult
        .replace(/'/g, '"')     
        .replace(/\bTrue\b/g, 'true')  
        .replace(/\bFalse\b/g, 'false')
        .replace(/\bNone\b/g, 'null')   
        .replace(/\n/g, '')    
        .trim();

    try {
        parsedActual = JSON.parse(cleaned);
    } catch {
        parsedActual = result.actualResult.trim();
    }
}


                const passed = JSON.stringify(parsedActual) == JSON.stringify(testCase.expected);
                if (!passed) allPassed = false;
                
                if (result.consoleOutput) {
                    consoleOutput.innerHTML += `[Test Case ${i+1}]:\n${result.consoleOutput}\n\n`;
                }
               
                const resultDiv = document.createElement('div');
                const isError = result.actualResult.toLowerCase().includes('error');
                resultDiv.className = `p-3 mb-2 rounded border-start border-5 ${passed ? 'border-success bg-success-subtle' : 'border-danger bg-danger-subtle'}`;
                resultDiv.innerHTML = `
                    <div class="fw-bold">Test Case ${i + 1}: ${passed ? 'Passed' : 'Failed'}</div>
                    <div class="small"><strong>Input:</strong> ${JSON.stringify(testCase.input)}</div>
                    <div class="small"><strong>Expected:</strong> ${JSON.stringify(testCase.expected)}</div>
                    <div class="small"><strong>Your Output:</strong> <span class="${isError ? 'text-danger' : ''}">${result.actualResult}</span></div>
                `;
                if (i === 0) resultsOutput.innerHTML = '';
                resultsOutput.appendChild(resultDiv);
            }
             if (allPassed) {
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success fw-bold text-center';
                successDiv.textContent = 'Congratulations! All test cases passed!';
                resultsOutput.prepend(successDiv);
                
                successFeedbackContainer.style.display = 'block';
                successFeedbackContent.textContent = 'Generating feedback on your solution...';
                const feedback = await getSuccessFeedback(currentLanguage, userCode, currentQuestion.title);
                
                successFeedbackContent.textContent = feedback;
             }
             runCodeBtn.disabled = false;
        }

        getClueBtn.addEventListener('click', async () => {
            feedbackContainer.textContent = "Getting a hint/suggestion...";
            getClueBtn.disabled = true;
            const code = editor.getValue();
                const feedback = await getFeedbackForCode(code, currentQuestion.title);
                if (feedback && !feedback.startsWith("ERROR:")) {
                     feedbackContainer.textContent = `${feedback}`;
                }
          
            getClueBtn.disabled = false;
        });
        
        runCodeBtn.addEventListener('click', runCode);

        langButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                setLanguage(btn.id.replace('lang-', ''));
            });
        });
        
        
        setLanguage('python');

       
    </script>
</body>
</html>